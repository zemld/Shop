# Shop Microservices Project

## Оглавление

- Обзор микросервисов
- Взаимодействие сервисов
- Флоу сбора заказа и паттерны
- Базы данных
- Инструкция по запуску

---

## Обзор микросервисов

### 1. **user-service**

- **Назначение:** Управление пользователями и их балансами.
- **Доступ:** `http://localhost:8081`
- **Эндпоинты:**
  - `POST /v1/users/register` — регистрация пользователя (`name`, `balance`)
  - `GET /v1/users/{userID}` — проверка регистрации пользователя
  - `POST /v1/users/change-balance` — изменение баланса пользователя
  - `GET /v1/users/balance` — получение баланса пользователя

### 2. **admin-service**

- **Назначение:** Управление администраторами и товарами на складе.
- **Доступ:** `http://localhost:8082`
- **Эндпоинты:**
  - `POST /v1/admins/register` — регистрация администратора
  - `GET /v1/admins/auth` — проверка прав администратора
  - `POST /v1/items/add` — добавление товара
  - `POST /v1/items/remove` — удаление товара
  - `POST /v1/items/update-price` — изменение цены товара
  - `POST /v1/items/deliver` — поставка товара на склад
  - `POST /v1/items/buy` — покупка товара

### 3. **item-service**

- **Назначение:** Управление товарами и их количеством на складе.
- **Доступ:** `http://localhost:8083`
- **Эндпоинты:**
  - `POST /v1/items/add` — добавить товар
  - `POST /v1/items/remove` — удалить товар
  - `POST /v1/items/update-price` — изменить цену товара
  - `POST /v1/items/deliver` — принять поставку товара
  - `POST /v1/items/buy` — купить товар

### 4. **order-service**

- **Назначение:** Управление созданием и обработкой заказов.
- **Доступ:** `http://localhost:8084`
- **Эндпоинты:**
  - `POST /v1/orders/create-order` — создать новый заказ

### 5. **payment-service**

- **Назначение:** Обработка оплаты заказов, взаимодействие с балансом пользователя.
- **Доступ:** Внешнего HTTP API нет, сервис работает через очередь сообщений (NATS).
- **Эндпоинты:** Нет HTTP-эндпоинтов, взаимодействие только через события в NATS.

### 6. **api-gateway**

- **Назначение:** Единая точка входа для клиентов, проксирование запросов к другим сервисам.
- **Доступ:** `http://localhost:8080`
- **Эндпоинты:** Повторяют основные эндпоинты всех сервисов, обеспечивая единый API для клиента.

---

## Взаимодействие сервисов

- **Синхронное взаимодействие:**  
  - api-gateway ↔ user-service, admin-service, item-service, order-service (HTTP)
- **Асинхронное взаимодействие:**  
  - order-service, item-service, payment-service используют NATS для обмена сообщениями (pub/sub).

---

## Флоу сбора заказа и паттерны

### Флоу заказа (SAGA)

1. Клиент отправляет запрос на создание заказа через api-gateway.
2. **order-service** сохраняет заказ в outbox (паттерн Transactional Outbox) и публикует событие через NATS.
3. **item-service** получает событие, проверяет наличие товаров, резервирует их и отправляет подтверждение через NATS.
4. **payment-service** получает подтверждение, проверяет баланс пользователя (HTTP-запрос к user-service), списывает средства и отправляет результат через NATS.
5. **order-service** получает финальный статус и завершает обработку заказа.

- **SAGA:**  
  Для обеспечения согласованности между сервисами используется паттерн SAGA — каждый шаг подтверждается или отменяется через события в очереди.
- **Transactional Outbox:**  
  Заказы сначала сохраняются в отдельной таблице (outbox) в одной транзакции с изменениями состояния, после чего событие отправляется в очередь. Это гарантирует, что событие не потеряется при сбоях.

---

## Базы данных

- Каждый сервис использует свою отдельную PostgreSQL-базу.
- **user-service:** таблица пользователей с балансом (ограничение: баланс ≥ 0)
- **admin-service:** таблицы администраторов и товаров
- **item-service:** таблица товаров (ограничения: цена ≥ 0, количество ≥ 0)
- **order-service:** таблица заказов и outbox для transactional outbox
- **payment-service:** не хранит собственные данные, взаимодействует с другими сервисами

---

## Инструкция по запуску

Для запуска всех сервисов используйте:

```bash
docker-compose up -d --build
```

Документация по каждому сервису доступна по адресу `/swagger/` соответствующего порта (например, `http://localhost:8081/swagger/` для user-service).
